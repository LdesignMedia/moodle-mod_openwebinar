/*! videojs-contrib-hls - v0.17.9 - 2015-09-02
* Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at
* https://github.com/videojs/videojs-contrib-hls/blob/master/LICENSE
* */
!function(t,e,s,i){"use strict";var a,r,n,l=1.1,o=500;r=function(t){return t.retries&&t.retries>=2},e.Hls=e.Flash.extend({init:function(t,s,i){var a=s.source,r=t.options();t.hls=this,delete s.source,s.swf=r.flash.swf,e.Flash.call(this,t,s,i),s.source=a,this.bytesReceived=0,this.hasPlayed_=!1,this.on(t,"loadstart",function(){this.hasPlayed_=!1,this.one(this.mediaSource,"sourceopen",this.setupFirstPlay)}),this.on(t,["play","loadedmetadata"],this.setupFirstPlay),this.currentTime=e.Hls.prototype.currentTime,this.setCurrentTime=e.Hls.prototype.setCurrentTime,this.segmentBuffer_=[],this.startCheckingBuffer_(),e.Hls.prototype.src.call(this,s.source&&s.source.src)}}),e.options.techOrder.unshift("hls"),e.Hls.GOAL_BUFFER_LENGTH=30,e.Hls.LIVE_SYNC_DURATION_COUNT=3,e.Hls.prototype.src=function(t){var s,r,n,l=this,o=this.player(),h=o.options().hls||{};t&&(this.src_&&this.resetSrc_(),this.src_=t,s=new e.MediaSource,n={src:e.URL.createObjectURL(s),type:"video/flv"},this.mediaSource=s,this.segmentBuffer_=[],this.segmentParser_=new e.Hls.SegmentParser,this.setupMetadataCueTranslation_(),this.mediaSource.addEventListener("sourceopen",e.bind(this,this.handleSourceOpen)),this.playlists&&this.playlists.dispose(),this.mediaIndex=0,this.playlists=new e.Hls.PlaylistLoader(this.src_,h.withCredentials),this.playlists.on("loadedmetadata",e.bind(this,function(){var t,s,a,n,l,h,d;r=this.playlists.media(),this.bandwidth===i&&this.setBandwidth({bandwidth:5*this.playlists.bandwidth}),t=this.selectPlaylist(),a=r.attributes&&r.attributes.BANDWIDTH||0,n=t.attributes&&t.attributes.BANDWIDTH||0,l=r.segments&&r.segments[this.mediaIndex].duration||r.targetDuration,h=l*n/this.bandwidth,h||(h=1/0),d=10,n>a&&d>=h?(this.playlists.media(t),s=e.bind(this,function(){this.setupFirstPlay(),this.fillBuffer(),o.trigger("loadedmetadata"),this.playlists.off("loadedplaylist",s)}),this.playlists.on("loadedplaylist",s)):(this.setupFirstPlay(),this.fillBuffer(),o.trigger("loadedmetadata"))})),this.playlists.on("error",e.bind(this,function(){o.error(this.playlists.error)})),this.playlists.on("loadedplaylist",e.bind(this,function(){var t=this.playlists.media();t&&(this.updateDuration(this.playlists.media()),this.mediaIndex=e.Hls.translateMediaIndex(this.mediaIndex,r,t),r=t,this.fetchKeys_())})),this.playlists.on("mediachange",e.bind(this,function(){a&&this.cancelKeyXhr(),o.trigger("mediachange")})),this.player().ready(function(){l.el()&&l.el().vjs_src(n.src)}))},e.Hls.getMediaIndexForLive_=function(t){if(!t.segments)return 0;for(var s=t.segments.length,i=0,a=(t.targetDuration||10)*e.Hls.LIVE_SYNC_DURATION_COUNT;a>i&&s>0;)i+=t.segments[s-1].duration,s--;return s},e.Hls.prototype.handleSourceOpen=function(){var t=this.player(),e=this.mediaSource.addSourceBuffer('video/flv; codecs="vp6,aac"');this.sourceBuffer=e,t.options().autoplay&&t.play(),e.appendBuffer(this.segmentParser_.getFlvHeader())},e.Hls.prototype.setupMetadataCueTranslation_=function(){var t,s=this,i=s.segmentParser_.metadataStream;s.player().addTextTrack&&(i.on("data",function(a){var r,n;if(!t)for(t=s.player().addTextTrack("metadata","Timed Metadata"),t.inBandMetadataTrackDispatchType=e.Hls.SegmentParser.STREAM_TYPES.metadata.toString(16).toUpperCase(),r=0;r<i.descriptor.length;r++)n=("00"+i.descriptor[r].toString(16).toUpperCase()).slice(-2),t.inBandMetadataTrackDispatchType+=n;s.segmentBuffer_[0].pendingMetadata.push({textTrack:t,metadata:a})}),s.on(s.player(),"seeking",function(){var i,a,r;if(t)for(i=s.playlists.media(),a=s.playlists.expiredPreDiscontinuity_+s.playlists.expiredPostDiscontinuity_,a+=e.Hls.Playlist.duration(i,i.mediaSequence,i.mediaSequence+s.mediaIndex),r=t.cues.length;r--;)t.cues[r].startTime>=a&&t.removeCue(t.cues[r])}))},e.Hls.prototype.addCuesForMetadata_=function(s){var i,a,r,n,l,o,h,d,u;for(h=this.playlists.expiredPreDiscontinuity_,h+=this.playlists.expiredPostDiscontinuity_,h+=e.Hls.Playlist.duration(s.playlist,s.playlist.mediaSequence,s.playlist.mediaSequence+s.mediaIndex),o=s.playlist.segments[s.mediaIndex],l=Math.min(isFinite(o.minVideoPts)?o.minVideoPts:1/0,isFinite(o.minAudioPts)?o.minAudioPts:1/0);s.pendingMetadata.length;){for(n=s.pendingMetadata[0].metadata,d=s.pendingMetadata[0].textTrack,i=0;i<n.frames.length;i++)r=n.frames[i],u=h+.001*(n.pts-l),a=new t.VTTCue(u,u,r.value||r.url||""),a.frame=r,a.pts_=n.pts,d.addCue(a);s.pendingMetadata.shift()}},e.Hls.prototype.setupFirstPlay=function(){var t,e;e=this.playlists.media(),!this.hasPlayed_&&this.sourceBuffer&&e&&this.paused()===!1&&(this.hasPlayed_=!0,1/0===this.duration()&&(t=this.seekable(),t.length&&this.setCurrentTime(t.end(0))))},e.Hls.prototype.play=function(){return this.ended()&&(this.mediaIndex=0),this.hasPlayed_?(1/0===this.duration()&&this.currentTime()<this.seekable().start(0)&&this.setCurrentTime(this.seekable().start(0)),void e.Flash.prototype.play.apply(this,arguments)):(e.Flash.prototype.play.apply(this,arguments),this.setupFirstPlay())},e.Hls.prototype.currentTime=function(){return this.lastSeekedTime_?this.lastSeekedTime_:this.el()&&this.el().vjs_getProperty?this.el().vjs_getProperty("currentTime"):0},e.Hls.prototype.setCurrentTime=function(t){return this.playlists&&this.playlists.media()&&this.playlists.media().segments?(t<this.seekable().start(0)?t=this.seekable().start(0):t>this.seekable().end(0)&&(t=this.seekable().end(0)),this.lastSeekedTime_=t,this.mediaIndex=this.playlists.getMediaIndexForTime_(t),this.sourceBuffer&&this.sourceBuffer.abort(),this.cancelSegmentXhr(),a&&(a.aborted=!0,this.cancelKeyXhr()),this.segmentBuffer_=[],void this.fillBuffer(1e3*t)):0},e.Hls.prototype.duration=function(){var t=this.playlists;return t?e.Hls.Playlist.duration(t.media()):0},e.Hls.prototype.seekable=function(){var t,s,i;return this.playlists&&(i=this.playlists.media())?(t=e.Hls.Playlist.seekable(i),t.length?(s=this.playlists.expiredPostDiscontinuity_-this.playlists.expiredPreDiscontinuity_,e.createTimeRange(s,s+(t.end(0)-t.start(0)))):t):e.createTimeRange()},e.Hls.prototype.updateDuration=function(t){var s=this.player(),i=s.duration(),a=e.Hls.Playlist.duration(t);i!==a&&s.trigger("durationchange")},e.Hls.prototype.resetSrc_=function(){this.cancelSegmentXhr(),this.cancelKeyXhr(),this.sourceBuffer&&this.sourceBuffer.abort()},e.Hls.prototype.cancelKeyXhr=function(){a&&(a.onreadystatechange=null,a.abort(),a=null)},e.Hls.prototype.cancelSegmentXhr=function(){this.segmentXhr_&&(this.segmentXhr_.onreadystatechange=null,this.segmentXhr_.abort(),this.segmentXhr_=null)},e.Hls.prototype.dispose=function(){this.stopCheckingBuffer_(),this.playlists&&this.playlists.dispose(),this.resetSrc_(),e.Flash.prototype.dispose.call(this)},e.Hls.prototype.selectPlaylist=function(){var t,s,i,a,r,n,o,h,d=this.player(),u=this.playlists.master.playlists.slice(),p=[],y=u.length;for(u.sort(e.Hls.comparePlaylistBandwidth);y--;)s=u[y],s.attributes&&s.attributes.BANDWIDTH&&(t=s.attributes.BANDWIDTH*l,t<d.hls.bandwidth&&(p.push(s),a||(a=s)));for(y=p.length,p.sort(e.Hls.comparePlaylistResolution),s=null,o=parseInt(getComputedStyle(d.el()).width,10),h=parseInt(getComputedStyle(d.el()).height,10);y--;)if(i=s,s=p[y],s.attributes&&s.attributes.RESOLUTION&&s.attributes.RESOLUTION.width&&s.attributes.RESOLUTION.height){if(s.attributes.RESOLUTION.width===o&&s.attributes.RESOLUTION.height===h){r=null,n=s;break}if(s.attributes.RESOLUTION.width<o&&s.attributes.RESOLUTION.height<h){i&&i.attributes&&i.attributes.RESOLUTION&&i.attributes.RESOLUTION.width&&i.attributes.RESOLUTION.height&&(r=i),n=s;break}}return r||n||a||u[0]},e.Hls.prototype.checkBuffer_=function(){this.checkBufferTimeout_&&(t.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=null),this.fillBuffer(),this.drainBuffer(),this.checkBufferTimeout_=t.setTimeout(e.bind(this,this.checkBuffer_),o)},e.Hls.prototype.startCheckingBuffer_=function(){this.player().on("waiting",e.bind(this,this.drainBuffer)),this.checkBuffer_()},e.Hls.prototype.stopCheckingBuffer_=function(){t.clearTimeout(this.checkBufferTimeout_),this.checkBufferTimeout_=null,this.player().off("waiting",this.drainBuffer)},e.Hls.prototype.fillBuffer=function(t){var s,a,r=this.player(),n=r.buffered(),l=0;(r.hasClass("vjs-has-started")||"none"!==r.options().preload)&&r.currentSrc()&&this.playlists&&(this.segmentXhr_||"HAVE_NOTHING"!==this.playlists.state&&this.playlists.media()&&this.playlists.media().segments&&(this.playlists.media().endList||r.hasClass("vjs-has-started")||t!==i)&&"SWITCHING_MEDIA"!==this.playlists.state&&(s=this.playlists.media().segments[this.mediaIndex],s&&(n&&(l=r.buffered().end(0)-r.currentTime()),"number"!=typeof t&&l>=e.Hls.GOAL_BUFFER_LENGTH||(a=this.playlistUriToUrl(s.uri),this.loadSegment(a,t)))))},e.Hls.prototype.playlistUriToUrl=function(t){var e;return e=this.playlists.media().uri===this.src_?n(this.src_,t):n(n(this.src_,this.playlists.media().uri||""),t)},e.Hls.prototype.setBandwidth=function(t){var e=this;e.segmentXhrTime=t.roundTripTime,e.bandwidth=t.bandwidth,e.bytesReceived+=t.bytesReceived||0,e.trigger("bandwidthupdate")},e.Hls.prototype.loadSegment=function(t,s){var i=this,a=this.player(),r=a.options().hls||{};this.segmentXhr_=e.Hls.xhr({url:t,responseType:"arraybuffer",withCredentials:r.withCredentials},function(t,e){var r;return i.segmentXhr_=null,t?"timeout"===t?(i.bandwidth=1,i.playlists.media(i.selectPlaylist())):(i.error={status:this.status,message:"HLS segment request error at URL: "+e,code:this.status>=500?4:2},void i.mediaIndex++):void(this.response&&(i.setBandwidth(this),r={mediaIndex:i.mediaIndex,playlist:i.playlists.media(),offset:s,bytes:null,encryptedBytes:null,decrypter:null,pendingMetadata:[]},r.playlist.segments[r.mediaIndex].key?r.encryptedBytes=new Uint8Array(this.response):r.bytes=new Uint8Array(this.response),i.segmentBuffer_.push(r),a.trigger("progress"),i.drainBuffer(),i.mediaIndex++,i.playlists.media(i.selectPlaylist())))})},e.Hls.prototype.drainBuffer=function(t){var s,i,a,n,l,o,h,d,u,p,y=0,c=0,f=this.segmentBuffer_;if(f.length&&this.sourceBuffer&&!this.sourceBuffer.updating){if(s=f[0],i=s.mediaIndex,a=s.playlist,n=s.offset,o=s.bytes,h=a.segments[i],h.key&&!o)return r(h.key)?f.shift():h.key.bytes?s.decrypter?void 0:(u=h.key.iv||new Uint32Array([0,0,0,i+a.mediaSequence]),d=new e.Hls.Decrypter(s.encryptedBytes,h.key.bytes,u,function(t,e){s.bytes=e}),void(s.decrypter=d)):this.fetchKeys_();for(t=t||{},this.segmentParser_.parseSegmentBinaryData(o),this.segmentParser_.flushTags(),l=[],this.segmentParser_.tagsAvailable()&&(this.segmentParser_.stats.h264Tags()&&(h.minVideoPts=this.segmentParser_.stats.minVideoPts(),h.maxVideoPts=this.segmentParser_.stats.maxVideoPts()),this.segmentParser_.stats.aacTags()&&(h.minAudioPts=this.segmentParser_.stats.minAudioPts(),h.maxAudioPts=this.segmentParser_.stats.maxAudioPts()));this.segmentParser_.tagsAvailable();)l.push(this.segmentParser_.getNextTag());if(this.addCuesForMetadata_(s),this.updateDuration(this.playlists.media()),"number"==typeof n){if(l.length){for(c=this.playlists.expiredPostDiscontinuity_+this.playlists.expiredPreDiscontinuity_,c+=e.Hls.Playlist.duration(a,a.mediaSequence,a.mediaSequence+i),c=n-1e3*c,p=c+l[0].pts;l[y+1]&&l[y].pts<p;)y++;this.el().vjs_setProperty("currentTime",.001*(l[y].pts-p+n)),l=l.slice(y)}this.lastSeekedTime_=null}h.discontinuity&&l.length&&this.el().vjs_discontinuity(),function(){var t,e,s=0;for(y=0;y<l.length;y++)s+=l[y].bytes.byteLength;for(e=new Uint8Array(s),y=0,t=0;y<l.length;y++)e.set(l[y].bytes,t),t+=l[y].bytes.byteLength;this.sourceBuffer.appendBuffer(e)}.call(this),f.shift(),1/0!==this.duration()&&i+1===a.segments.length&&this.mediaSource.endOfStream()}},e.Hls.prototype.fetchKeys_=function(){var t,s,i,n,l,o,h,d;if(!a&&this.segmentBuffer_.length)for(i=this,n=this.player(),l=n.options().hls||{},d=function(t){return function(e){return a=null,e||!this.response||16!==this.response.byteLength?(t.retries=t.retries||0,t.retries++,void(this.aborted||i.fetchKeys_())):(h=new DataView(this.response),t.bytes=new Uint32Array([h.getUint32(0),h.getUint32(4),h.getUint32(8),h.getUint32(12)]),void i.checkBuffer_())}},t=0;t<i.segmentBuffer_.length;t++)if(o=i.segmentBuffer_[t].playlist.segments[i.segmentBuffer_[t].mediaIndex],s=o.key,s&&!s.bytes&&!r(s)){a=e.Hls.xhr({url:this.playlistUriToUrl(s.uri),responseType:"arraybuffer",withCredentials:l.withCredentials},d(s));break}},e.Hls.supportsNativeHls=function(){var t,i,a=s.createElement("video");return e.Html5.isSupported()?(t=a.canPlayType("application/x-mpegURL"),i=a.canPlayType("application/vnd.apple.mpegURL"),/probably|maybe/.test(t)||/probably|maybe/.test(i)):!1}(),e.Hls.isSupported=function(){return!e.Hls.supportsNativeHls&&e.Flash.isSupported()&&e.MediaSource&&t.Uint8Array},e.Hls.canPlaySource=function(t){var e=/^application\/(?:x-|vnd\.apple\.)mpegurl/i;return e.test(t.type)},e.Hls.getPlaylistDuration=function(t,s,i){return e.log.warn("videojs.Hls.getPlaylistDuration is deprecated. Use videojs.Hls.Playlist.duration instead"),e.Hls.Playlist.duration(t,s,i)},e.Hls.getPlaylistTotalDuration=function(t){return e.log.warn("videojs.Hls.getPlaylistTotalDuration is deprecated. Use videojs.Hls.Playlist.duration instead"),e.Hls.Playlist.duration(t)},e.Hls.translateMediaIndex=function(t,s,i){var a;return 0===t?0:i&&i.segments?(a=t+(s.mediaSequence-i.mediaSequence),a>i.segments.length||0>a?e.Hls.getMediaIndexForLive_(i)+1:a):0},e.Hls.getMediaIndexByTime=function(){return e.log.warn("getMediaIndexByTime is deprecated. Use PlaylistLoader.getMediaIndexForTime_ instead."),0},e.Hls.comparePlaylistBandwidth=function(e,s){var i,a;return e.attributes&&e.attributes.BANDWIDTH&&(i=e.attributes.BANDWIDTH),i=i||t.Number.MAX_VALUE,s.attributes&&s.attributes.BANDWIDTH&&(a=s.attributes.BANDWIDTH),a=a||t.Number.MAX_VALUE,i-a},e.Hls.comparePlaylistResolution=function(e,s){var i,a;return e.attributes&&e.attributes.RESOLUTION&&e.attributes.RESOLUTION.width&&(i=e.attributes.RESOLUTION.width),i=i||t.Number.MAX_VALUE,s.attributes&&s.attributes.RESOLUTION&&s.attributes.RESOLUTION.width&&(a=s.attributes.RESOLUTION.width),a=a||t.Number.MAX_VALUE,i===a&&e.attributes.BANDWIDTH&&s.attributes.BANDWIDTH?e.attributes.BANDWIDTH-s.attributes.BANDWIDTH:i-a},n=e.Hls.resolveUrl=function(t,e){var i,a,r=s.querySelector("base"),n=s.querySelector("head"),l=s.createElement("a"),o=r;return r?i=r.href:o=n.appendChild(s.createElement("base")),o.href=t,l.href=e,a=l.href,r?r.href=i:n.removeChild(o),a}}(window,window.videojs,document);